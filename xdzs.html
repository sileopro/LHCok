<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>下单助手</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; background-color: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        input, button, textarea { margin: 5px; padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        button { cursor: pointer; font-weight: bold; transition: all 0.3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #latestResult { margin-top: 20px; padding: 10px; background-color: #FFB6C1; border-radius: 5px; }
        #orderSummary { margin-top: 20px; padding: 10px; background-color: #A4D3EE; border-radius: 5px; }
        #winAmount { margin-top: 20px; padding: 10px; background-color: #BDFCC9; border-radius: 5px; }
        .odds-item { display: inline-block; margin-right: 10px; }
        .odds-item.saved { color: #888; }
        #pasteBtn { background-color: #4CAF50; color: white; }
        #calculateBtn, #profitDisplay { background-color: #2196F3; color: white; }
        #settleBtn { background-color: #FF9800; color: white; }
        #saveOddsBtn { background-color: #9C27B0; color: white; }
        #editOddsBtn { background-color: #788A5E; color: white; } /* 苔古色 */
        #addOddsBtn { background-color: #E91E63; color: white; }
        .odds-container { 
            display: none; 
            margin-top: 10px; 
            background-color: #E6F3FF; /* 浅蓝色 */
            padding: 10px; 
            border-radius: 5px; 
        }
        .odds-container.show { display: block; }
        .odds-item { margin-bottom: 10px; }
        input::placeholder { color: #888; font-style: italic; }
        .odds-item input { font-size: 16px; }
        #profitDisplay { display: inline-block; padding: 10px; border-radius: 5px; margin-left: 10px; }
        .ball { display: inline-block; width: 30px; height: 30px; border-radius: 50%; background-color: #f00; color: white; text-align: center; line-height: 30px; margin-right: 5px; font-weight: bold; }
        .special-ball { background-color: #00f; }
        .attribute {
            display: inline-block;
            padding: 4px 8px; /* 增大内边距 */
            margin: 0 3px; /* 增大外边距 */
            border-radius: 5px; /* 增大圆角 */
            font-size: 16px; /* 增大字体 */
        }
        .sx { background-color: #800080; color: white; } /* 紫色背景，白色字体 */
        .red { background-color: #FF0000; color: white; }
        .blue { background-color: #0000FF; color: white; }
        .green { background-color: #008000; color: white; }
        .dan { background-color: #FF1493; color: white; }
        .shuang { background-color: #4169E1; color: white; }
        .da { background-color: #FF8C00; color: white; }
        .xiao { background-color: #008B8B; color: white; }
        .attribute.red.dan, .attribute.red.shuang, .attribute.red.da, .attribute.red.xiao { background-color: #FF0000; color: white; }
        .attribute.blue.dan, .attribute.blue.shuang, .attribute.blue.da, .attribute.blue.xiao { background-color: #0000FF; color: white; }
        .attribute.green.dan, .attribute.green.shuang, .attribute.green.da, .attribute.green.xiao { background-color: #008000; color: white; }
        #colorfulOrderBtn { background-color: #FFD700; color: white; margin-left: 10px; } /* 小金库按钮字体改为白色 */
        /* .odds-container { background-color: #788A5E; } /* 苔古色 */ */
        #orderInput > div {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }

        #orderInput > div > * {
            margin-right: 10px;
            margin-bottom: 5px;
        }

        #profitDisplay, #orderSummary, #winAmount {
            flex-basis: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>下单助手</h1>
        <div id="latestResult">最新开奖结果: 加载中...</div>
        
        <h2>玩法设置</h2>
        <button id="editOddsBtn">修改玩法</button>
        <button id="colorfulOrderBtn" style="background-color: #FFD700; color: black;">小金库</button>
        <button id="deleteOrderBtn" style="background-color: #FF4500; color: white;">删除记录</button>
        <div id="oddsContainer" class="odds-container">
            <!-- 玩法项目将通过 JavaScript 动态添加 -->
        </div>
        <button id="addOddsBtn" style="display:none;">添加玩法</button>
        <button id="saveOddsBtn" style="display:none;">保存玩法</button>
        
        <h2>下单区</h2>
        <div style="display: flex; align-items: stretch;">
            <div id="orderInput" style="width: 45%; display: flex; flex-direction: column;">
                <textarea id="orderTextarea" rows="10" cols="50" placeholder="输入或粘贴下单内容" style="flex-grow: 1;"></textarea>
                <div style="margin-top: 10px;">
                    <button id="pasteBtn">粘贴</button>
                    <button id="calculateBtn">计算</button>
                    <button id="settleBtn">兑奖</button>
                </div>
                <div style="margin-top: 10px;">
                    <span id="profitDisplay" style="display: inline-block; padding: 5px 10px; background-color: #2196F3; color: white; border-radius: 5px;"></span>
                </div>
                <div style="margin-top: 10px;">
                    <span id="orderSummary" style="display: inline-block; padding: 5px 10px; background-color: #A4D3EE; border-radius: 5px;"></span>
                </div>
                <div style="margin-top: 10px;">
                    <span id="winAmount" style="display: inline-block; padding: 5px 10px; background-color: #BDFCC9; border-radius: 5px;"></span>
                </div>
            </div>
            <div id="winningDetails" style="width: 45%; margin-left: 2cm; border: 1px solid #ccc; padding: 10px; display: flex; flex-direction: column;">
                <h3>中奖详情</h3>
                <div id="winningContent" style="flex-grow: 1; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        let latestResult = {};
        let odds = {
            '特码': 47,
            '红波': 1.8, '蓝波': 1.8, '绿波': 1.8,
            '单': 1.8, '双': 1.8,
            '大': 1.8, '小': 1.8,
            '波色单双': 3.6,
            '大小单双': 3.6,
            '生肖': 11.75
        };

        console.log("脚本开始执行");

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM 加载完成，开始初始化");
            
            loadLatestResult();
            loadOdds();
            loadLastOrder(); // 新增：加载最后一次的下单内容
            setInterval(loadLatestResult, 60000);

            document.getElementById('editOddsBtn').addEventListener('click', showOddsEditor);
            document.getElementById('addOddsBtn').addEventListener('click', function() {
                addOddsItem('', '');
            });
            document.getElementById('saveOddsBtn').addEventListener('click', saveOdds);
            document.getElementById('pasteBtn').addEventListener('click', pasteOrder);
            document.getElementById('calculateBtn').addEventListener('click', calculateOrder);
            document.getElementById('settleBtn').addEventListener('click', settleOrder);
            document.getElementById('colorfulOrderBtn').addEventListener('click', showColorfulOrder); // 添加这一行
            document.getElementById('deleteOrderBtn').addEventListener('click', deleteOrder);

            console.log("初始化完成");
        });

        function loadOdds() {
            const defaultOdds = {
                '特码': 47,
                '红波': 1.8, '蓝波': 1.8, '绿波': 1.8,
                '单': 1.8, '双': 1.8,
                '大': 1.8, '小': 1.8,
                '波色单双': 3.6,
                '大小单双': 3.6,
                '生肖': 11.75
            };

            const savedOdds = localStorage.getItem('odds');
            if (savedOdds) {
                odds = {...defaultOdds, ...JSON.parse(savedOdds)};
            } else {
                odds = defaultOdds;
            }
            updateOddsDisplay();
        }

        function updateOddsDisplay() {
            const container = document.getElementById('oddsContainer');
            container.innerHTML = '';
            for (const [name, value] of Object.entries(odds)) {
                addOddsItem(name, value);
            }
        }

        function addOddsItem(name = '', value = '') {
            const container = document.getElementById('oddsContainer');
            const item = document.createElement('div');
            item.className = 'odds-item';
            item.innerHTML = `
                <input type="text" class="oddsName" value="${name}" placeholder="玩法名称">
                <input type="number" class="oddsValue" step="0.1" value="${value}" placeholder="赔率">
                <button class="removeOddsBtn">删除</button>
            `;
            container.appendChild(item);
            item.querySelector('.removeOddsBtn').addEventListener('click', function() {
                container.removeChild(item);
            });
        }

        function showOddsEditor() {
            document.getElementById('oddsContainer').style.display = 'block';
            document.getElementById('addOddsBtn').style.display = 'inline-block';
            document.getElementById('saveOddsBtn').style.display = 'inline-block';
            document.getElementById('editOddsBtn').style.display = 'none';
        }

        function saveOdds() {
            const container = document.getElementById('oddsContainer');
            const items = container.getElementsByClassName('odds-item');
            const newOdds = {};
            for (let item of items) {
                const name = item.querySelector('.oddsName').value;
                const value = parseFloat(item.querySelector('.oddsValue').value);
                if (name && !isNaN(value)) {
                    newOdds[name] = value;
                }
            }
            odds = newOdds;
            localStorage.setItem('odds', JSON.stringify(odds));
            
            // 更新显示
            updateOddsDisplay();
            
            // 不隐藏编辑界面，只更新按钮状态
            document.getElementById('addOddsBtn').style.display = 'inline-block';
            document.getElementById('saveOddsBtn').style.display = 'inline-block';
            document.getElementById('editOddsBtn').style.display = 'none';
            
            alert('玩法已保存');
        }

        function loadLatestResult() {
            fetch('output.html')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('无法加载开奖结果文件');
                    }
                    return response.text();
                })
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const lastRow = doc.querySelector('table tr:last-child');
                    if (lastRow) {
                        const cells = lastRow.querySelectorAll('td');
                        latestResult = {
                            period: cells[0].textContent,
                            numbers: cells[1].textContent.trim().split(' '),
                            special: cells[2].textContent,
                            attributes: cells[3].textContent
                        };
                        // 从属性中提取颜色信息
                        const colorMatch = latestResult.attributes.match(/(红|蓝|绿)/);
                        if (colorMatch) {
                            latestResult.color = colorMatch[1];
                        }
                        console.log("解析的开奖结果:", latestResult);
                        
                        let resultHTML = `<strong>最新开奖结果: ${latestResult.period}期：</strong>`;
                        latestResult.numbers.forEach(num => {
                            const ballColor = getBallColor(num);
                            resultHTML += `<span class="ball" style="background-color: ${ballColor};">${num}</span>`;
                        });
                        resultHTML += ` + <span class="ball special-ball" style="background-color: ${getBallColor(latestResult.special)};">${latestResult.special}</span> `;
                        
                        // 添加特码属性，参考 output.html 的样式
                        const attributes = latestResult.attributes.split(' ');
                        attributes.forEach(attr => {
                            let className = '';
                            if (['鼠', '牛', '虎', '兔', '龙', '蛇', '马', '羊', '猴', '鸡', '狗', '猪'].includes(attr)) {
                                className = 'sx';
                            } else if (['红', '蓝', '绿'].includes(attr)) {
                                className = attr === '红' ? 'red' : (attr === '蓝' ? 'blue' : 'green');
                            } else if (attr.includes('单') || attr.includes('双')) {
                                className = attr.includes('单') ? 'dan' : 'shuang';
                            } else if (attr.includes('大') || attr.includes('小')) {
                                className = attr.includes('大') ? 'da' : 'xiao';
                            }
                            
                            // 处理组合属性
                            if (attr.length > 1 && ['红', '蓝', '绿'].some(color => attr.includes(color))) {
                                if (attr.includes('单') || attr.includes('双')) {
                                    className += ' ' + (attr.includes('单') ? 'dan' : 'shuang');
                                }
                                if (attr.includes('大') || attr.includes('小')) {
                                    className += ' ' + (attr.includes('大') ? 'da' : 'xiao');
                                }
                            }
                            
                            resultHTML += `<span class="attribute ${className}" style="font-weight: bold;">${attr}</span>`;
                        });
                        
                        document.getElementById('latestResult').innerHTML = resultHTML;
                    } else {
                        throw new Error('无法解析开奖结果');
                    }
                })
                .catch(error => {
                    console.error('加载开奖结果时出错:', error);
                    document.getElementById('latestResult').textContent = '无法加载最新开奖结果: ' + error.message;
                });
        }

        function getBallColor(number) {
            const redNumbers = [1, 2, 7, 8, 12, 13, 18, 19, 23, 24, 29, 30, 34, 35, 40, 45, 46];
            const blueNumbers = [3, 4, 9, 10, 14, 15, 20, 25, 26, 31, 36, 37, 41, 42, 47, 48];
            const greenNumbers = [5, 6, 11, 16, 17, 21, 22, 27, 28, 32, 33, 38, 39, 43, 44, 49];

            number = parseInt(number);
            if (redNumbers.includes(number)) return '#FF0000';
            if (blueNumbers.includes(number)) return '#0000FF';
            if (greenNumbers.includes(number)) return '#008000';
            return '#000000'; // 默认黑色
        }

        function pasteOrder() {
            navigator.clipboard.readText().then(text => {
                document.getElementById('orderTextarea').value = text;
            });
        }

        function calculateOrder() {
            console.log("开始计算订单");
            const orderText = document.getElementById('orderTextarea').value;
            console.log("订单内容:", orderText);
            const lines = orderText.split('\n');
            let totalAmount = 0;
            let isProcessingOrder = true;

            lines.forEach((line, index) => {
                line = line.trim();
                if (line === '') return;

                console.log(`处理第 ${index + 1} 行:`, line);
                
                // 检查是否为合计行或其他结束标记
                if (line.includes('合计') || line.includes('总计') || line.toLowerCase().includes('total')) {
                    isProcessingOrder = false;
                    console.log("检测到合计行，停止处理后续内容");
                    return;
                }

                if (!isProcessingOrder) return;

                // 提取所有金额
                const amountMatches = line.match(/\d+/g);
                if (!amountMatches) {
                    console.log(`无法解析金额: ${line}`);
                    return;
                }

                // 处理特码或"各"的情况
                if (line.includes('特码') || line.includes('各')) {
                    const betAmount = parseInt(amountMatches[amountMatches.length - 1]);
                    const numbers = amountMatches.slice(0, -1);
                    const actualAmount = line.includes('各') ? betAmount * numbers.length : betAmount;
                    totalAmount += actualAmount;
                    console.log(`特码或各: 数量 ${numbers.length}, 金额 ${actualAmount}`);
                } else {
                    // 处理其他下注
                    amountMatches.forEach(amount => {
                        totalAmount += parseInt(amount);
                        console.log(`解析到的金额: ${amount}`);
                    });
                }
            });

            const summary = `订单总计: ${totalAmount}元`;
            console.log("计算结果:", summary);
            document.getElementById('orderSummary').textContent = summary;
            saveLastOrder();
        }

        function settleOrder() {
            if (!latestResult || !latestResult.special) {
                alert('无法获取最新开奖结果，请稍后再试');
                return;
            }

            const totalAmountMatch = document.getElementById('orderSummary').textContent.match(/订单总计: (\d+)元/);
            if (!totalAmountMatch) {
                alert('请先计算订单总额');
                return;
            }
            const totalAmount = parseFloat(totalAmountMatch[1]);
            const winningNumbers = {
                numbers: latestResult.numbers,
                special: parseInt(latestResult.special),
                attributes: latestResult.attributes
            };

            console.log("开奖结果:", latestResult);

            const totalWinAmount = calculateProfit(winningNumbers);
            const profit = totalWinAmount - totalAmount;

            document.getElementById('winAmount').textContent = `本期中奖金额: ${totalWinAmount.toFixed(2)}元`;
            document.getElementById('profitDisplay').textContent = `本期盈利: ${profit.toFixed(2)}元`;

            saveOrderHistory();
            console.log("订单历史已保存，当前历史记录数量:", orderHistory.length);
            saveLastOrder();
        }

        function calculateProfit(winningNumbers) {
            console.log("开始计算盈利");
            console.log("中奖号码:", winningNumbers);
            const orderText = document.getElementById('orderTextarea').value;
            const lines = orderText.split('\n');
            let totalWinAmount = 0;
            let winningDetails = [];

            const winningAttributes = winningNumbers.attributes.toLowerCase().split(/\s+/);
            const winningColor = latestResult.color.toLowerCase();
            const winningOddEven = winningNumbers.special % 2 === 0 ? '双' : '单';
            const winningBigSmall = parseInt(winningNumbers.special) > 24 ? '大' : '小';
            const winningAnimal = winningAttributes.find(attr => ['鼠', '牛', '虎', '兔', '龙', '蛇', '马', '羊', '猴', '鸡', '狗', '猪'].includes(attr));

            winningDetails.push(`中奖属性: 特码=${winningNumbers.special}, 生肖=${winningAnimal}, 颜色=${winningColor}, 单双=${winningOddEven}, 大小=${winningBigSmall}`);
            winningDetails.push('<hr>');

            lines.forEach((line, index) => {
                line = line.trim().toLowerCase();
                if (line === '' || line.includes('合计') || line.includes('总计')) return;

                const amountMatches = line.match(/\d+/g);
                if (!amountMatches) return;

                if (line.includes('特码') || line.includes('各')) {
                    const betAmount = parseInt(amountMatches[amountMatches.length - 1]);
                    const numbers = amountMatches.slice(0, -1);
                    const actualAmount = line.includes('各') ? betAmount : betAmount / numbers.length;
                    if (numbers.includes(winningNumbers.special.toString())) {
                        const winAmount = actualAmount * odds['特码'];
                        totalWinAmount += winAmount;
                        winningDetails.push(`特码中奖: 金额=${actualAmount}, 赔率=${odds['特码']}, 赢得=${winAmount}`);
                        winningDetails.push('<hr>');
                    }
                } else {
                    const bets = line.split(/\s+/).filter(part => isNaN(parseInt(part)));
                    const betAmounts = amountMatches.map(amount => parseInt(amount));

                    bets.forEach((bet, i) => {
                        const currentBetAmount = betAmounts[i] || betAmounts[betAmounts.length - 1];
                        let winAmount = 0;
                        if (bet.includes('波')) {
                            if (bet.includes(winningColor)) {
                                if ((bet.includes('单') || bet.includes('双')) && bet.includes(winningOddEven)) {
                                    winAmount = currentBetAmount * odds['波色单双'];
                                    winningDetails.push(`半波中奖: 金额=${currentBetAmount}, 赔率=${odds['波色单双']}, 赢得=${winAmount}`);
                                    winningDetails.push('<hr>');
                                } else if ((bet.includes('大') || bet.includes('小')) && bet.includes(winningBigSmall)) {
                                    winAmount = currentBetAmount * odds['波色单双'];
                                    winningDetails.push(`半波中奖: 金额=${currentBetAmount}, 赔率=${odds['波色单双']}, 赢得=${winAmount}`);
                                    winningDetails.push('<hr>');
                                } else {
                                    winAmount = currentBetAmount * odds[winningColor + '波'];
                                    winningDetails.push(`波色中奖: 金额=${currentBetAmount}, 赔率=${odds[winningColor + '波']}, 赢得=${winAmount}`);
                                    winningDetails.push('<hr>');
                                }
                            }
                        } else if ((bet === '单' || bet === '双') && bet === winningOddEven) {
                            winAmount = currentBetAmount * odds[winningOddEven];
                            winningDetails.push(`单双中奖: 金额=${currentBetAmount}, 赔率=${odds[winningOddEven]}, 赢得=${winAmount}`);
                            winningDetails.push('<hr>');
                        } else if ((bet === '大' || bet === '小') && bet === winningBigSmall) {
                            winAmount = currentBetAmount * odds[winningBigSmall];
                            winningDetails.push(`大小中奖: 金额=${currentBetAmount}, 赔率=${odds[winningBigSmall]}, 赢得=${winAmount}`);
                            winningDetails.push('<hr>');
                        } else if (bet === winningAnimal) {
                            winAmount = currentBetAmount * odds['生肖'];
                            winningDetails.push(`生肖中奖: 金额=${currentBetAmount}, 赔率=${odds['生肖']}, 赢得=${winAmount}`);
                            winningDetails.push('<hr>');
                        } else if (bet === winningColor + winningOddEven) {
                            winAmount = currentBetAmount * odds['波色单双'];
                            winningDetails.push(`波色单双中奖: 金额=${currentBetAmount}, 赔率=${odds['波色单双']}, 赢得=${winAmount}`);
                            winningDetails.push('<hr>');
                        }
                        totalWinAmount += winAmount;
                    });
                }
            });

            winningDetails.push(`总计赢得: ${totalWinAmount}`);
            document.getElementById('winningContent').innerHTML = winningDetails.join('');
            console.log("中奖详情:", winningDetails.join('\n'));
            return totalWinAmount;
        }

        let orderHistory = [];

        let passwordValidUntil = 0;

        function checkPassword() {
            const now = Date.now();
            if (now < passwordValidUntil) {
                return true;
            }
            const password = prompt("请输入密码：");
            if (password === null) {
                return false; // 用户点击取消时直接返回 false
            }
            if (password === "369369") {
                passwordValidUntil = now + 10 * 60 * 1000; // 10分钟有效期
                return true;
            }
            alert("密码错误！");
            return false;
        }

        function showColorfulOrder() {
            if (checkPassword()) {
                console.log("密码正确，准备显示历史记录");
                console.log("当前历史记录数量:", orderHistory.length);
                const historyText = orderHistory.join('\n\n\n');
                console.log("历史记录内容:", historyText);
                const historyWindow = window.open("", "历史下单记录", "width=600,height=400");
                historyWindow.document.write(`
                    <html>
                        <head>
                            <style>
                                .highlight { background-color: yellow; }
                            </style>
                        </head>
                        <body>
                            <pre>${historyText.replace(/★/g, '<span class="highlight">').replace(/★/g, '</span>')}</pre>
                        </body>
                    </html>
                `);
                historyWindow.document.close();
            }
            // 如果 checkPassword() 返回 false，函数将直接结束，不做任何操作
        }

        function deleteOrder() {
            if (checkPassword()) {
                const period = prompt("请输入要删除的期数：");
                if (period) {
                    const index = orderHistory.findIndex(order => order.includes(`开奖结果: ${period}期`));
                    if (index !== -1) {
                        orderHistory.splice(index, 1);
                        alert("记录已删除");
                    } else {
                        alert("未找到该期数的记录");
                    }
                }
            }
            // 如果 checkPassword() 返回 false，函数将直接结束，不做任何操作
        }

        function loadLastOrder() {
            const lastOrder = localStorage.getItem('lastOrder');
            if (lastOrder) {
                document.getElementById('orderTextarea').value = lastOrder;
            }
        }

        function saveLastOrder() {
            const orderInput = document.getElementById('orderTextarea').value;
            localStorage.setItem('lastOrder', orderInput);
        }

        function saveOrderHistory() {
            const currentOrder = `
开奖结果: ${document.getElementById('latestResult').textContent}
下单内容:
${document.getElementById('orderTextarea').value}
订单总计: ${document.getElementById('orderSummary').textContent.match(/订单总计: (\d+)元/)[1]}元
本期盈利: ${document.getElementById('profitDisplay').textContent.split(': ')[1]}
----------------------------------------
`;
            orderHistory.push(currentOrder);
            console.log("新的订单历史已添加，当前历史记录数量:", orderHistory.length);
            console.log("最新添加的记录:", currentOrder);
        }

        document.getElementById('colorfulOrderBtn').addEventListener('click', showColorfulOrder);
        document.getElementById('deleteOrderBtn').addEventListener('click', deleteOrder);
    </script>
</body>
</html>